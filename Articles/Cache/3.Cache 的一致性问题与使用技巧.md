# Cache 的一致性问题与使用技巧


- 在重启之后，用户必须在使能 cache 之前 Invalidate 每个 cache 中的数据，否则程序可能会发生不可预测的行为
- 在关闭 data cache 的时候，用户必须清除整个 cache，确保所有被修改的过的数据被写入到主存中
- 如果主存中的数据在 cache 关闭的过程中被修改过，那么在使能 data cache 之前，必须作废 data cache 中的数据
- 如果主存中的数据在 cache 关闭的过程中被修改过，那么在使能 instruction cache 之前，必须作废 instruction cache 中的数据
- 如果软件将可以被缓存的内存区域用做 DMA 的源或者目标缓冲区。那么软件在开启一次 DMA 操作之前，必须触发一次 cache 清理，来确保被修改的数据被写入到子系统的内存中。在 DMA 传输完成之后，当从外设读取数据时，软件必须在读取 DMA 更新的内存区域之前执行一次 cache 数据的作废
- 使用不能被 cache 缓存的区域作为 DMA 的缓冲区永远是更好的。软件上可以使用 MPU 来设置一块不能被 cache 缓存的内存来作为 CPU 和 DMA 之间的共享内存
- 不要对频繁执行 DMA 操作的内存块使能 cache
- 当使用 ART 加速器时，CPU 可以在一个时钟周期内从内部闪存存储器中读取一条指令。所以这时候 I-cache 不能被用于内部闪存存储器
- 当使用 NOR Flash 时，回写操作会引发问题，因为擦除和写命令不能被发送到外部闪存存储器
- 当 cache 连接的设备是普通的内存，D-cache 读取是十分有用的。然而如果连接的设备是一个专用的集成电路或者是一个 FIFO，用户必须关闭 D-cache 读取。否则 CPU 可能频繁读取到相同或者错误的数据。

