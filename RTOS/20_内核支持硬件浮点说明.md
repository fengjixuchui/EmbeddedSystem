# 内核支持硬件浮点说明

如果想在宏内核版本的 RT-Thread 中进行支持硬件浮点运算，就需要在移植时支持浮点，并且在编译和链接的时候开启硬件浮点支持选项（例如 `-mfpu=vfpv3 -mfloat-abi=hard`）。

移植时处理硬件浮点支持，需要处理如下三种情况：

1. 只是发生中断，而不进行线程切换时，只需要在发生中断时，将所有的寄存器（包括浮点寄存器） push 到中断栈中，在中断退出时，从中断栈中恢复先前线程上下文的寄存器组。
2. 如果是需要进行线程切换的情况，发生中断的时候，需要将所有的寄存器（包括浮点寄存器） push 到中断栈中，然后进行中断处理，最后在切换到新线程之前，将保存在中断栈中的当前线程的 context 拷贝到线程的栈的对应位置中。
3. 在情况 2 之后，此时需要切换到新线程中，接下来需要从新线程的栈帧中，将相关硬件浮点寄存器的值恢复到新线程运行环境的寄存器组中。

情况 1 和情况 2 的区别是，第一种情况将中断栈里保存的上下文直接恢复到寄存器组里，第二种情况是将在中断栈里保存的上下文再次保存到当前线程栈中对应的位置上。

## 结论

使系统支持浮点运算的过程，主要添加的功能就是保存和恢复浮点寄存器中的内容，在合适的时候将数据保存在中断栈中，然后在重新切换回线程环境时，选择是将寄存器内容恢复到寄存器还是保存到相应线程的栈中。