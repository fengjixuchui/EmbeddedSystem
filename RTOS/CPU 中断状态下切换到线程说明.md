# CPU 中断状态下切换到线程上下文说明

在 SPARC 上关于中断嵌套情况下的，中断返回问题的疑问，情况如下：

- 首先发生较低优先级的中断
- 该低优先级中断被高优先级中断打断
- 在高优先级中断里释放信号量唤醒线程
- 在高优先级中断退出时，是否会出现直接切换到线程，而回到到低优先级中断的情况

## 问题解释

上述问题发生在允许中断嵌套的情况下，针对这个问题，需要讨论两类不同的 CPU 中断设计：

1. CPU 进入中断的同时会屏蔽同类型的中断，如 IRQ 或 FIQ

2. CPU 进入中断时不会屏蔽中断，这种 CPU 会在进入中断时会自动保存一部分程序现场

对于第一类 CPU，这种 CPU 比较常见，例如 cortex-A 系列等。在 RT-Thread 操作系统中，进入中断后，**需要先将 `rt_interrupt_nest` 加一后再打开中断**，这就能确保即使该中断被更高优先级的中断打断返回，`rt_interrupt_nest` 的值仍然至少为 1，这就使得此时不会通过调度函数切换到线程上下文，而是必须等到最低一级中断完全处理完后，进行中断退出时，才会切换回线程状态。通过这种方式可以保证，如果中断没有完全退出，是不可能越过低级别的中断处理，直接切换到线程状态的。

对于第二类 CPU（例如 cortex-M），CPU 必须提供自动保存一部分上下文的功能，以避免中断被打断，造成现场破坏的问题。以 cortex-M 系列 CPU 为例，其线程切换总是在 `pendSV` 中进行，而 `pendSV` 是一种异常级别最低的异常，因此从硬件机制上保证了线程的切换操作只能在所有的中断都退出的情况下进行。也就不可能发生中断没有完全退出而直接切换到线程的情形。

